#!/bin/bash
# =============================================================================
# 롤백 스크립트
# =============================================================================
#
# 사용법:
#   ./rollback.sh
#
# 동작:
#   1. 현재 활성 환경 확인
#   2. 이전 환경 시작 (이미 빌드된 이미지 사용)
#   3. Nginx upstream 전환
#   4. 현재 환경 종료
#
# 주의: 이전 배포의 이미지가 아직 존재해야 함 (prune 되지 않은 경우)
#
# =============================================================================

set -e

# -----------------------------------------------------------------------------
# 설정
# -----------------------------------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"
INFRA_DIR="$PROJECT_DIR/infra"
COMPOSE_FILE="$INFRA_DIR/docker-compose.production.yml"
ACTIVE_ENV_FILE="$PROJECT_DIR/.active-env"

# 색상
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# -----------------------------------------------------------------------------
# 현재 활성 환경 확인
# -----------------------------------------------------------------------------
if [ ! -f "$ACTIVE_ENV_FILE" ]; then
    echo -e "${RED}[ERROR]${NC} 활성 환경 파일이 없습니다: $ACTIVE_ENV_FILE"
    echo "배포가 한 번도 실행되지 않은 것 같습니다."
    exit 1
fi

CURRENT_ENV=$(cat "$ACTIVE_ENV_FILE")

if [ "$CURRENT_ENV" = "blue" ]; then
    ROLLBACK_ENV="green"
else
    ROLLBACK_ENV="blue"
fi

echo -e "${YELLOW}[ROLLBACK]${NC} 롤백 시작"
echo "  현재 환경: $CURRENT_ENV"
echo "  롤백 대상: $ROLLBACK_ENV"

# -----------------------------------------------------------------------------
# 확인 프롬프트
# -----------------------------------------------------------------------------
read -p "정말 롤백하시겠습니까? (y/N): " confirm
if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "롤백이 취소되었습니다."
    exit 0
fi

# -----------------------------------------------------------------------------
# 1. 이전 환경 시작 (앱 서비스만)
# -----------------------------------------------------------------------------
echo -e "${YELLOW}[START]${NC} $ROLLBACK_ENV 환경 시작 중..."

docker compose -f "$COMPOSE_FILE" --profile "$ROLLBACK_ENV" up -d --no-deps \
    core-api-"$ROLLBACK_ENV" \
    ai-server-"$ROLLBACK_ENV" \
    web-client-"$ROLLBACK_ENV"

# -----------------------------------------------------------------------------
# 2. 헬스체크
# -----------------------------------------------------------------------------
echo -e "${YELLOW}[HEALTH]${NC} 헬스체크 대기 중..."

"$SCRIPT_DIR/health-check.sh" "$ROLLBACK_ENV" 120

# -----------------------------------------------------------------------------
# 3. Nginx upstream 전환
# -----------------------------------------------------------------------------
echo -e "${YELLOW}[SWITCH]${NC} Nginx upstream 전환..."

"$SCRIPT_DIR/switch-upstream.sh" "$ROLLBACK_ENV"

# -----------------------------------------------------------------------------
# 4. 활성 환경 기록
# -----------------------------------------------------------------------------
echo "$ROLLBACK_ENV" > "$ACTIVE_ENV_FILE"

# -----------------------------------------------------------------------------
# 5. 현재 환경 종료 (nginx 제외)
# -----------------------------------------------------------------------------
echo -e "${YELLOW}[STOP]${NC} $CURRENT_ENV 환경 종료 중..."

docker compose -f "$COMPOSE_FILE" rm -sf \
    core-api-"$CURRENT_ENV" \
    ai-server-"$CURRENT_ENV" \
    web-client-"$CURRENT_ENV"

# -----------------------------------------------------------------------------
# 완료
# -----------------------------------------------------------------------------
echo -e "${GREEN}[SUCCESS]${NC} ============================================"
echo -e "${GREEN}[SUCCESS]${NC} 롤백 완료!"
echo -e "${GREEN}[SUCCESS]${NC}   이전 환경: $CURRENT_ENV"
echo -e "${GREEN}[SUCCESS]${NC}   현재 환경: $ROLLBACK_ENV"
echo -e "${GREEN}[SUCCESS]${NC} ============================================"